#!/bin/bash
#
currentArchitecture=$(dpkg --print-architecture)

# The priorities that are required to be installed.
requiredPriorities="$requiredPriorities required"
requiredPriorities="$requiredPriorities important"
requiredPriorities="$requiredPriorities standard"
#requiredPriorities="$requiredPriorities optional"
#requiredPriorities="$requiredPriorities extra"

# The packages that are required to be installed.
# The Base system
requiredPackages="$requiredPackages grub-efi"
requiredPackages="$requiredPackages linux-image-${currentArchitecture}"
requiredPackages="$requiredPackages firmware-linux"
requiredPackages="$requiredPackages firmware-atheros"
requiredPackages="$requiredPackages lvm2 thin-provisioning-tools"

# Tasks
requiredPackages="$requiredPackages task-english"
requiredPackages="$requiredPackages task-desktop"
requiredPackages="$requiredPackages task-dutch"
requiredPackages="$requiredPackages task-dutch-desktop"
requiredPackages="$requiredPackages task-gnome-desktop libreoffice-gtk2"
requiredPackages="$requiredPackages task-ssh-server"

# Other packages
requiredPackages="$requiredPackages adb fastboot"
requiredPackages="$requiredPackages aptitude apt-transport-https"
requiredPackages="$requiredPackages autofs cifs-utils smbclient"
requiredPackages="$requiredPackages binutils-m68hc1x"
requiredPackages="$requiredPackages borgmatic"
requiredPackages="$requiredPackages brasero"
requiredPackages="$requiredPackages build-essential devscripts git-buildpackage lintian quilt"
requiredPackages="$requiredPackages ccache cscope indent"
requiredPackages="$requiredPackages chromium"
requiredPackages="$requiredPackages cups"
requiredPackages="$requiredPackages discover"
requiredPackages="$requiredPackages docker-ce qemu-user-static"
requiredPackages="$requiredPackages dump"
requiredPackages="$requiredPackages freeplane"
requiredPackages="$requiredPackages gimp"
requiredPackages="$requiredPackages git gitk git-flow kdiff3"
requiredPackages="$requiredPackages gnome-shell-extension-system-monitor gnome-shell-extension-top-icons-plus"
requiredPackages="$requiredPackages gnucash"
requiredPackages="$requiredPackages gramps gir1.2-gexiv2-0.10 gir1.2-osmgpsmap-1.0 graphviz python3-icu python3-pil"
requiredPackages="$requiredPackages gthumb"
requiredPackages="$requiredPackages handbrake libdvdcss2"
requiredPackages="$requiredPackages htop"
requiredPackages="$requiredPackages iptables"
requiredPackages="$requiredPackages josm gpsprune"
requiredPackages="$requiredPackages jq"
requiredPackages="$requiredPackages jxplorer ldap-utils shelldap"
requiredPackages="$requiredPackages kicad kicad-doc-en"
requiredPackages="$requiredPackages libh2-java"
requiredPackages="$requiredPackages librecad"
requiredPackages="$requiredPackages maven"
requiredPackages="$requiredPackages openjdk-11-jdk openjdk-11-source openjdk-11-doc"
requiredPackages="$requiredPackages pan"
requiredPackages="$requiredPackages pgdg-keyring pgadmin4"
requiredPackages="$requiredPackages popularity-contest"
requiredPackages="$requiredPackages python2"	# for ing2ofx
requiredPackages="$requiredPackages qemu-system-arm"
requiredPackages="$requiredPackages reprepro"
requiredPackages="$requiredPackages rsync"
requiredPackages="$requiredPackages sane-airscan"
requiredPackages="$requiredPackages seahorse"
requiredPackages="$requiredPackages seahorse-nautilus"
requiredPackages="$requiredPackages simple-scan"
requiredPackages="$requiredPackages smartmontools smart-notifier gsmartcontrol"
requiredPackages="$requiredPackages strace"
requiredPackages="$requiredPackages sudo"
requiredPackages="$requiredPackages telegram-desktop"
requiredPackages="$requiredPackages vim"

# Which packages are already installed?
autoInstalledPackages=$(apt-mark showauto)
manualInstalledPackages=$(apt-mark showmanual)

# All available packages with descriptions.
apt-cache dumpavail | \
awk \
	-v currentArchitecture="$currentArchitecture" \
	-v requiredPrioritiesString="$requiredPriorities" \
	-v requiredPackagesString="$requiredPackages" \
	-v autoInstalledPackagesString="$autoInstalledPackages" \
	-v manualInstalledPackagesString="$manualInstalledPackages" \
	-- '
	function stringToArray(s, a,
			a1, i, v) {
		split(s, a1, "[ \t\r\n]+")
		for (i in a1) {
			v = a1[i]
			if (v != "") {
				a[v] = "true"
			}
		}
	}
	BEGIN {
		stringToArray(requiredPrioritiesString, requiredPriorities)
		stringToArray(requiredPackagesString, requiredPackages)
		stringToArray(autoInstalledPackagesString, autoInstalledPackages)
		stringToArray(manualInstalledPackagesString, manualInstalledPackages)
	}
	$1 == "Package:" { Package = $2 }
	$1 == "Architecture:" { Architecture = $2 }
	$1 == "Essential:" { Essential = $2 }
	$1 == "Priority:" { Priority = $2 }
	$0 == "" && Package != "" {
		if (Architecture == currentArchitecture || Architecture == "all" || Architecture == "") {
			packageName = Package
		} else {
			packageName = Package ":" Architecture
		}
		isRequired = false
		isRequired = isRequired || (Essential != "" && Package == packageName)
		isRequired = isRequired || (Priority in requiredPriorities && Package == packageName)
		isRequired = isRequired || (packageName in requiredPackages)
		isRequired = isRequired && ! (packageName "-" in requiredPackages)
		if (isRequired) {
			if (packageName in autoInstalledPackages) {
				toBeMarkedManual[packageName] = "true"
			} else if (!(packageName in manualInstalledPackages)) {
				toBeInstalled[packageName] = "true"
			}
		} else {
			if (packageName in manualInstalledPackages) {
				toBeMarkedAuto[packageName] = "true"
			}
		}
	}
	$0 == "" {
		Package = ""
		Architecture = ""
		Essential = ""
		Priority = ""
	}
	END {
		for (package in toBeInstalled) { print package "+" }
		for (package in toBeMarkedAuto) { print package "&M" }
		for (package in toBeMarkedManual) { print package "&m" }
	}
' | \
xargs --no-run-if-empty --verbose aptitude --schedule-only install

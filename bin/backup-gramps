#!/bin/bash
#

# Lock the execution of this script.
[ "${FLOCKER}" != "$0" ] && exec env FLOCKER="$0" flock --exclusive "$0" "$0" "$@" || :

function usage() {
	echo "Usage: $0 <destination>" >&2
	echo "	<destination>	A directory where the backup is saved" >&2
	exit 1
}

backup_dir="$1"
[ -d "$backup_dir" ] || usage

unset DISPLAY

gramps -l | tail -n +3 | while read grampsDir dummy1 dummy2 name
do
	name="${name#\"}"
	name="${name%\"}"
	backup_file="${backup_dir}/${name}.gramps"
	backup_file_old="${backup_file}.old"
	backup_file_new="${backup_file}.new"
	[ -f "$backup_file_new" ] && rm -f "$backup_file_new"
	XDG_RUNTIME_DIR=/tmp gramps --open="$grampsDir" --export="$backup_file_new" --format=gramps 2>/dev/null
	status="$?"
	if [ "$status" -eq 0 ]
	then
		[ -f "$backup_file_old" ] && rm -f "$backup_file_old"
		[ -f "$backup_file" ]     && mv "$backup_file" "$backup_file_old"
		[ -f "$backup_file_new" ] && mv "$backup_file_new" "$backup_file"
	fi
done
